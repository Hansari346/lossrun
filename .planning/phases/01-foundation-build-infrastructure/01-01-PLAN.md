---
phase: 01-foundation-build-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - wrangler.jsonc
  - vite.config.ts
  - tsconfig.json
  - tsconfig.app.json
  - tsconfig.node.json
  - index.html
  - src/main.tsx
  - src/app.tsx
  - src/styles.css
  - src/types/globals.d.ts
  - src/types/index.ts
  - src/state/store.ts
autonomous: true

must_haves:
  truths:
    - "Vite dev server starts and serves a page at localhost with HMR"
    - "Vite production build produces a dist/ directory with client assets"
    - "TypeScript compiler accepts the project without errors (npm run typecheck)"
  artifacts:
    - path: "vite.config.ts"
      provides: "Vite build configuration with three plugins"
      contains: "preact()"
    - path: "src/state/store.ts"
      provides: "Centralized signal store replacing 6 global variables"
      exports: ["workbook", "currentSheetName", "headerRow", "mappings", "canonicalData", "chartInstances", "currentPage", "adjustments", "results"]
    - path: "src/types/index.ts"
      provides: "TypeScript domain model interfaces"
      exports: ["CanonicalRecord", "FieldDefinition", "Mappings", "AdjustmentParams", "CalculationResults"]
    - path: "index.html"
      provides: "SPA entry point with CDN scripts and Preact mount"
      contains: '<div id="app">'
    - path: "src/styles.css"
      provides: "Extracted CSS from monolith with Tailwind import"
      contains: '@import "tailwindcss"'
  key_links:
    - from: "index.html"
      to: "src/main.tsx"
      via: "script module src attribute"
      pattern: 'src="/src/main.tsx"'
    - from: "src/main.tsx"
      to: "src/app.tsx"
      via: "Preact render call"
      pattern: "render.*App"
    - from: "vite.config.ts"
      to: "wrangler.jsonc"
      via: "cloudflare plugin reads wrangler config"
      pattern: "cloudflare\\(\\)"
---

<objective>
Set up the Vite build toolchain, TypeScript configuration, Preact + Tailwind + Cloudflare plugins, centralized signal store, TypeScript domain types, and extract CSS from the monolith — producing a working dev server that serves a placeholder app.

Purpose: This is the foundation that every subsequent plan depends on. Without a working build pipeline, TypeScript types, and signal store, no code can be extracted from the monolith.
Output: A Vite project that builds, serves, and type-checks. All config files, the signal store, TypeScript interfaces, and extracted CSS ready for Plans 02-04 to build on.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-build-infrastructure/01-RESEARCH.md

@src/worker.js — The monolith. CSS lives in lines 14-398 (inside <style> tags). Global variables at top of <script> block. This file is READ-ONLY reference — do NOT modify it.
@wrangler.jsonc — Current config. Must be updated (remove main, add assets).
@package.json — Current config. Must be updated (add type:module, scripts, deps).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create all configuration files</name>
  <files>
    package.json
    vite.config.ts
    tsconfig.json
    tsconfig.app.json
    tsconfig.node.json
    wrangler.jsonc
  </files>
  <action>
    **Step 1: Install dependencies**

    Run these two commands:
    ```bash
    npm install preact @preact/signals tailwindcss
    npm install -D vite @cloudflare/vite-plugin @preact/preset-vite @tailwindcss/vite typescript @cloudflare/workers-types vitest@~3.2 @cloudflare/vitest-pool-workers
    ```

    **Step 2: Update package.json**

    Add `"type": "module"` at the top level. Replace the `scripts` section with:
    ```json
    "scripts": {
      "dev": "vite dev",
      "build": "vite build",
      "preview": "vite preview",
      "deploy": "npm run build && wrangler deploy",
      "typecheck": "tsc --noEmit",
      "test": "vitest run"
    }
    ```
    Keep the existing `name`, `version`, `private` fields. Dependencies will be managed by npm.

    **Step 3: Create vite.config.ts**

    Three plugins in this exact order — framework plugins first, platform plugin last:
    ```typescript
    import { defineConfig } from "vite";
    import preact from "@preact/preset-vite";
    import tailwindcss from "@tailwindcss/vite";
    import { cloudflare } from "@cloudflare/vite-plugin";

    export default defineConfig({
      plugins: [
        preact(),
        tailwindcss(),
        cloudflare(),
      ],
    });
    ```

    **Step 4: Create tsconfig.json** (project references)
    ```jsonc
    {
      "files": [],
      "references": [
        { "path": "./tsconfig.app.json" },
        { "path": "./tsconfig.node.json" }
      ]
    }
    ```

    **Step 5: Create tsconfig.app.json** (Preact application code)
    ```jsonc
    {
      "compilerOptions": {
        "target": "ES2022",
        "module": "ESNext",
        "moduleResolution": "bundler",
        "jsx": "react-jsx",
        "jsxImportSource": "preact",
        "strict": true,
        "noUnusedLocals": true,
        "noUnusedParameters": true,
        "noFallthroughCasesInSwitch": true,
        "isolatedModules": true,
        "skipLibCheck": true,
        "baseUrl": ".",
        "paths": {
          "react": ["./node_modules/preact/compat/"],
          "react/jsx-runtime": ["./node_modules/preact/jsx-runtime"],
          "react-dom": ["./node_modules/preact/compat/"],
          "react-dom/*": ["./node_modules/preact/compat/*"]
        },
        "types": ["vite/client"]
      },
      "include": ["src/**/*.ts", "src/**/*.tsx"]
    }
    ```

    **Step 6: Create tsconfig.node.json** (Vite config / build tools)
    ```jsonc
    {
      "compilerOptions": {
        "target": "ES2022",
        "module": "ESNext",
        "moduleResolution": "bundler",
        "strict": true,
        "skipLibCheck": true,
        "isolatedModules": true,
        "noEmit": true
      },
      "include": ["vite.config.ts"]
    }
    ```

    **Step 7: Update wrangler.jsonc**

    Remove the `"main": "src/worker.js"` field. Remove `"workers_dev": true` and `"preview_urls": false`. Add `"assets"` section. Keep existing `routes` and `observability`. The updated file should be:
    ```jsonc
    {
      "$schema": "./node_modules/wrangler/config-schema.json",
      "name": "lossrun",
      "compatibility_date": "2025-12-10",
      "assets": {
        "not_found_handling": "single-page-application"
      },
      "routes": [
        {
          "pattern": "lossrun.voxelplatform.com",
          "zone_name": "voxelplatform.com",
          "custom_domain": true
        }
      ],
      "observability": {
        "enabled": true,
        "head_sampling_rate": 1,
        "logs": {
          "enabled": true,
          "head_sampling_rate": 1,
          "persist": true,
          "invocation_logs": true
        }
      }
    }
    ```
    Note: Remove the `traces` block if it exists — keep config minimal.

    **PITFALL WARNINGS:**
    - `"type": "module"` in package.json is REQUIRED — without it, Vite imports fail with `ERR_REQUIRE_ESM`
    - `@preact/preset-vite` MUST be listed BEFORE `cloudflare()` in the plugins array
    - Do NOT put `assets.directory` in wrangler.jsonc — the Cloudflare Vite plugin auto-generates it
    - Do NOT keep `main` field in wrangler.jsonc — it conflicts with SPA serving
  </action>
  <verify>
    Run `npm run typecheck` — should exit 0 (may warn about no input files, that's OK since src/ has no .ts files yet)
    Run `npx vite --version` — should print the installed version
  </verify>
  <done>
    All config files exist with correct content. npm scripts work. TypeScript and Vite are configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create source scaffolding — HTML entry, CSS extraction, types, store, and app shell</name>
  <files>
    index.html
    src/styles.css
    src/types/globals.d.ts
    src/types/index.ts
    src/state/store.ts
    src/main.tsx
    src/app.tsx
  </files>
  <action>
    **Step 1: Create index.html at project root**

    This is the SPA entry point. It includes CDN scripts (kept temporarily for Phase 1) and the Preact mount point. Do NOT include the full HTML body from the monolith — that will be rendered by Preact components.

    ```html
    <!doctype html>
    <html lang="en">
    <head>
      <meta charset="utf-8" />
      <title>Site Loss &amp; ROI Tool</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <!-- CDN libs kept temporarily (Phase 1) — will npm-install in later phases -->
      <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    </head>
    <body>
      <div id="app"></div>
      <script type="module" src="/src/main.tsx"></script>
    </body>
    </html>
    ```

    **Step 2: Extract CSS into src/styles.css**

    Open `src/worker.js` and copy EVERYTHING between the `<style>` and `</style>` tags (lines ~14-398 of the template literal). Paste it into `src/styles.css`. Add `@import "tailwindcss";` as the FIRST line. This ensures Tailwind base styles load first, then our custom CSS overrides them.

    The file structure should be:
    ```css
    @import "tailwindcss";

    /* === Extracted from monolith src/worker.js === */
    :root {
      font-family: 'Inter', system-ui, -apple-system, ...;
      /* ... all CSS custom properties ... */
    }
    body { ... }
    .app { ... }
    .nav { ... }
    /* ... rest of extracted CSS verbatim ... */
    ```

    Copy the CSS VERBATIM — do not rename classes, do not convert to Tailwind utilities. Preserve every rule exactly as-is. The only change is adding the Tailwind import at top.

    **Step 3: Create src/types/globals.d.ts**

    Declare CDN globals so TypeScript doesn't complain:
    ```typescript
    // Temporary declarations for CDN-loaded libraries
    // These will be replaced by proper npm imports in later phases
    declare const XLSX: any;
    declare const Chart: any;
    declare const pptxgen: any;
    ```

    **Step 4: Create src/types/index.ts**

    Define the core domain interfaces. These are derived from the monolith's data structures:

    ```typescript
    /** Definition of a mappable field (required or optional) */
    export interface FieldDefinition {
      label: string;
      description: string;
      required?: boolean;
      hints: string[];
      fieldType: 'text' | 'number' | 'date';
    }

    /** Column index mapping: canonical field name → column index in the sheet */
    export type Mappings = Record<string, number>;

    /** A single normalized claim record after column mapping */
    export interface CanonicalRecord {
      site_name: string;
      date_of_loss: Date | null;
      total_incurred: number;
      claim_number?: string;
      claim_category?: string;
      body_part?: string;
      lost_days?: number;
      cause_of_loss?: string;
      loss_description?: string;
      [key: string]: any;
    }

    /** User-configurable adjustment parameters */
    export interface AdjustmentParams {
      wcReduction: number;
      lostTimeReduction: number;
      retentionImprovement: number;
      miscCostReduction: number;
      obsSpeedImprovement: number;
      isExistingCustomer: boolean;
      voxelStartYear: number;
      annualize: boolean;
      annualizeMonths: number;
      observationCost: number;
    }

    /** Output of the calculation engine — consumed by charts, KPI tiles, and exports */
    export interface CalculationResults {
      // Counts
      totalClaims: number;
      moClaims: number;
      indemnClaims: number;
      // Costs
      totalIncurred: number;
      moIncurred: number;
      indemnIncurred: number;
      avgCostPerClaim: number;
      // Derived metrics
      trirCurrent: number;
      trirImproved: number;
      // Payback / ROI
      currentTotal: number;
      improvedTotal: number;
      savings: number;
      roi: number;
      paybackMonths: number;
      // Per-year breakdown for trend charts
      yearlyData: YearlyBreakdown[];
      // Category breakdowns
      categoryBreakdown: CategoryBreakdown[];
      bodyPartBreakdown: CategoryBreakdown[];
      causeBreakdown: CategoryBreakdown[];
      // Site comparison data
      siteComparison: SiteBreakdown[];
      // Chart-specific data objects
      chartData: Record<string, any>;
    }

    export interface YearlyBreakdown {
      year: number;
      claims: number;
      incurred: number;
      moClaims: number;
      indemnClaims: number;
      moIncurred: number;
      indemnIncurred: number;
    }

    export interface CategoryBreakdown {
      name: string;
      count: number;
      incurred: number;
      percentage: number;
    }

    export interface SiteBreakdown {
      site: string;
      claims: number;
      incurred: number;
      avgCost: number;
    }
    ```

    Note: The `CalculationResults` interface will likely need refinement during Plan 03 when the actual calculation logic is extracted. That's expected — start with this shape and adjust.

    **Step 5: Create src/state/store.ts**

    Replace the 6 global mutable variables from the monolith with Preact signals. Also add signals for wizard navigation, adjustments, results, and site filtering:

    ```typescript
    import { signal, computed } from "@preact/signals";
    import type { CanonicalRecord, Mappings, AdjustmentParams, CalculationResults } from "../types";

    // === Core data signals (replacing 6 global variables from monolith) ===
    export const workbook = signal<any>(null);
    export const currentSheetName = signal<string | null>(null);
    export const headerRow = signal<string[]>([]);
    export const mappings = signal<Mappings>({});
    export const canonicalData = signal<CanonicalRecord[]>([]);
    export const chartInstances = signal<Record<string, any>>({});

    // === Wizard navigation ===
    export const currentPage = signal<1 | 2 | 3>(1);

    // === Adjustment parameters (with defaults matching monolith's "Balanced" preset) ===
    export const adjustments = signal<AdjustmentParams>({
      wcReduction: 40,
      lostTimeReduction: 60,
      retentionImprovement: 10,
      miscCostReduction: 25,
      obsSpeedImprovement: 1.5,
      isExistingCustomer: false,
      voxelStartYear: new Date().getFullYear(),
      annualize: false,
      annualizeMonths: new Date().getMonth() + 1,
      observationCost: 0,
    });

    // === Calculation results ===
    export const results = signal<CalculationResults | null>(null);

    // === Site filtering ===
    export const selectedSite = signal<string>("all");
    export const availableSites = signal<string[]>([]);

    // === UI state ===
    export const isCalculating = signal<boolean>(false);
    export const statusMessage = signal<string>("");

    // === Derived state ===
    export const hasData = computed(() => canonicalData.value.length > 0);
    export const sheetNames = computed(() => {
      const wb = workbook.value;
      return wb ? (wb.SheetNames as string[]) ?? [] : [];
    });

    // === Reset ===
    export function resetState() {
      workbook.value = null;
      currentSheetName.value = null;
      headerRow.value = [];
      mappings.value = {};
      canonicalData.value = [];
      chartInstances.value = {};
      currentPage.value = 1;
      results.value = null;
      selectedSite.value = "all";
      availableSites.value = [];
      statusMessage.value = "";
    }
    ```

    **Step 6: Create src/main.tsx**

    Minimal entry point — renders the App into #app:
    ```tsx
    import { render } from "preact";
    import { App } from "./app";
    import "./styles.css";

    render(<App />, document.getElementById("app")!);
    ```

    **Step 7: Create src/app.tsx**

    Placeholder for now — will be fully wired in Plan 04:
    ```tsx
    export function App() {
      return (
        <div class="app">
          <div class="badge">
            <span>Loss &amp; ROI Analysis</span>
          </div>
          <h1>Site Loss Viewer &amp; Projected ROI</h1>
          <p style={{ color: "var(--muted)" }}>
            Build in progress — components loading in subsequent plans.
          </p>
        </div>
      );
    }
    ```

    **IMPORTANT:** Do NOT delete or modify `src/worker.js`. It stays as a read-only reference until Phase 1 is fully validated.
  </action>
  <verify>
    1. Run `npm run dev` — Vite dev server should start and serve at localhost (e.g., http://localhost:5173)
    2. Open the URL in a browser — should see the placeholder heading "Site Loss Viewer & Projected ROI"
    3. Run `npm run build` — should produce a `dist/` directory with client assets
    4. Run `npm run typecheck` — should exit 0 with no errors
    5. Verify that `src/worker.js` still exists untouched
  </verify>
  <done>
    Dev server starts with HMR. Production build succeeds. TypeScript compiles without errors. CSS is extracted from monolith. Signal store, types, and app shell are in place. The foundation is ready for Plans 02-04 to build on.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts Vite dev server at localhost
2. `npm run build` produces dist/ with client assets
3. `npm run typecheck` passes with exit code 0
4. Browser shows placeholder app at dev server URL
5. CDN scripts (XLSX, Chart, pptxgen) load without console errors
6. `src/worker.js` is untouched
</verification>

<success_criteria>
- Vite dev server starts and serves a working page
- TypeScript compiles without errors
- All config files (vite, tsconfig, wrangler, package.json) have correct content
- Signal store exports all required signals
- Types file exports all domain interfaces
- CSS extracted verbatim from monolith with Tailwind import
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-build-infrastructure/01-01-SUMMARY.md`
</output>
