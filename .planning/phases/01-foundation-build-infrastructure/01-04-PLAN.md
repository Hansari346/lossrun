---
phase: 01-foundation-build-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/components/adjustments-page.tsx
  - src/components/results-page.tsx
  - src/app.tsx
  - index.html
autonomous: false

must_haves:
  truths:
    - "Full wizard flow works: upload file → map columns → configure adjustments → view results with KPI tiles and charts"
    - "All 11 chart types render correctly in the browser when their data supports them"
    - "PowerPoint export generates and downloads a .pptx file"
    - "Application deploys to Cloudflare Workers and serves correctly at the production URL"
    - "No inline <script> remains in index.html — all logic is in TypeScript modules"
  artifacts:
    - path: "src/components/adjustments-page.tsx"
      provides: "Adjustment configuration UI with sliders, presets, observation cost calculator"
      min_lines: 150
    - path: "src/components/results-page.tsx"
      provides: "Results page with KPI tiles, 11 chart canvases, and export button"
      min_lines: 150
    - path: "src/app.tsx"
      provides: "Root component with signal-driven page routing importing all page components"
      contains: "currentPage"
  key_links:
    - from: "src/app.tsx"
      to: "src/state/store.ts"
      via: "currentPage signal drives which page component renders"
      pattern: "currentPage\\.value"
    - from: "src/app.tsx"
      to: "src/components/*"
      via: "imports and conditionally renders all page components"
      pattern: "UploadPage|AdjustmentsPage|ResultsPage|Nav"
    - from: "src/components/adjustments-page.tsx"
      to: "src/lib/calculations.ts"
      via: "Calculate button triggers calculateResults"
      pattern: "calculateResults"
    - from: "src/components/results-page.tsx"
      to: "src/lib/charts.ts"
      via: "useEffect calls drawCharts when results change"
      pattern: "drawCharts"
    - from: "src/components/results-page.tsx"
      to: "src/lib/export-ppt.ts"
      via: "Export button triggers exportToPPT with chart images"
      pattern: "exportToPPT"
---

<objective>
Build the remaining Preact components (adjustments page, results page), wire the complete App shell with signal-driven routing, verify the full wizard flow works end-to-end with `npm run dev`, then build and deploy to Cloudflare.

Purpose: This is the integration plan that brings everything together. After Plans 01-03 created the foundation, lib modules, and input UI, this plan completes the circuit — adjustments UI, results display with charts, app-level routing, and production deployment.
Output: A fully working Preact SPA that replicates all existing monolith functionality, deployed to Cloudflare Workers.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-build-infrastructure/01-RESEARCH.md

@src/worker.js — The monolith. Key sections for this plan:
  - Lines 520-695: Adjustments page HTML (page2 div)
  - Lines 696-968: Results page HTML (page3 div)
  - Lines 1254-1320: Event setup for existing customer toggle, adjustment inputs, presets
  - Lines 982-1010: toggleChart (collapse/expand chart sections)
  - Lines 3277-3330: toggleAdvanced, calculateObs, applyPreset

Prior plan summaries (read these for what's been built):
@.planning/phases/01-foundation-build-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-foundation-build-infrastructure/01-02-SUMMARY.md
@.planning/phases/01-foundation-build-infrastructure/01-03-SUMMARY.md

Source files to import from:
@src/state/store.ts
@src/types/index.ts
@src/lib/calculations.ts
@src/lib/charts.ts
@src/lib/export-ppt.ts
@src/lib/formatting.ts
@src/components/nav.tsx
@src/components/upload-page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Adjustments page and Results page components</name>
  <files>
    src/components/adjustments-page.tsx
    src/components/results-page.tsx
  </files>
  <action>
    **A. Create src/components/adjustments-page.tsx**

    Render the adjustments page (page 2). Extract from monolith lines 520-695 (HTML structure) plus lines 1254-1320 and 3277-3330 (event handling logic).

    The adjustments page has these sections:

    1. **Existing Customer toggle** — checkbox that switches between prospect mode and existing customer mode. When toggled:
       - Shows/hides the "Voxel Start Year" dropdown
       - Updates `adjustments.value.isExistingCustomer`

    2. **Preset buttons** — Conservative / Balanced / Aggressive. Clicking a preset calls `getPresetValues()` from calculations.ts and updates `adjustments.value`.

    3. **Improvement assumption sliders** — 5 range inputs:
       - WC Claim Reduction (%)
       - Lost Time Reduction (%)
       - Employee Retention Improvement (%)
       - Miscellaneous Cost Reduction (%)
       - Observation Speed Improvement (x multiplier)
       Each slider shows its current value and writes to `adjustments.value` on change.

    4. **Auto-populated injury metrics** — read-only display of values derived from ingested data (total claims, total incurred, avg cost, etc.)

    5. **Observation Cost Calculator** — expandable "Advanced" section with inputs for employee count, observations per employee, minutes per observation, avg hourly rate. Calls `calculateObservationCost()` from calculations.ts.

    6. **YTD Annualization controls** — toggle + month selector for annualizing partial-year data.

    7. **"Calculate & Show Results" button** — calls `calculateResults()` from calculations.ts, then navigates: `currentPage.value = 3`.

    Implementation notes:
    - Read/write `adjustments` signal for all form state. Use a pattern like:
      ```tsx
      const updateAdj = (key: string, value: any) => {
        adjustments.value = { ...adjustments.value, [key]: value };
      };
      ```
    - Use existing CSS classes from styles.css (`.card`, `.slider-row`, `.btn-preset`, etc.)
    - The "Advanced" section uses toggleAdvanced logic — implement as local boolean signal
    - Preset buttons should have an `.active` class on the currently selected preset

    **B. Create src/components/results-page.tsx**

    Render the results page (page 3). Extract from monolith lines 696-968 (HTML structure).

    The results page has these sections:

    1. **Header row** — title + Export buttons (PPT export, potentially Excel later)

    2. **KPI Summary tiles** — a grid of cards showing:
       - Total Claims (current)
       - Total Incurred (current)
       - Avg Cost Per Claim
       - TRIR (current vs improved)
       - Projected Savings
       - ROI / Payback Period
       Read all values from `results.value` signal. Format with `fmtMoney`, `fmtInt`, `fmtNum` from formatting.ts.

    3. **Chart sections** — 11 collapsible chart containers, each containing:
       - A header with chart title + collapse/expand toggle
       - A `<canvas>` element for Chart.js to render into
       Each chart section should only render if its data exists in `results.value`.

    4. **Chart rendering via useEffect** — when `results.value` changes:
       ```tsx
       import { useEffect, useRef } from "preact/hooks";
       import { drawCharts, destroyCharts } from "../lib/charts";
       import { chartInstances } from "../state/store";

       // In component:
       const canvasRefs = useRef<Record<string, HTMLCanvasElement | null>>({});

       useEffect(() => {
         if (!results.value) return;
         const instances = drawCharts(
           results.value,
           canvasRefs.current,
           chartInstances.value,
           adjustments.value.isExistingCustomer
         );
         chartInstances.value = instances;
         return () => destroyCharts(instances);
       }, [results.value]);
       ```

    5. **Export button handler** — clicking "Export to PowerPoint":
       ```tsx
       const handleExport = async () => {
         if (!results.value) return;
         // Collect chart images from canvas elements
         const chartImages: Record<string, string> = {};
         Object.entries(canvasRefs.current).forEach(([id, canvas]) => {
           if (canvas) chartImages[id] = canvas.toDataURL('image/png');
         });
         await exportToPPT(results.value, chartImages, adjustments.value.isExistingCustomer);
       };
       ```

    6. **Collapse/expand toggle** — each chart section can be collapsed. Use local signal or state per chart.

    Implementation notes:
    - Use `ref` callbacks to populate `canvasRefs.current`:
      ```tsx
      <canvas ref={(el) => { if (el) canvasRefs.current['chartId'] = el; }} />
      ```
    - Only render chart sections when their data is present in results (check for non-empty arrays/objects)
    - Use existing CSS classes from styles.css
    - Chart canvas elements need appropriate size (width/height or CSS)
    - The existing customer mode affects labels (e.g., "Projected" vs "Realized" savings)
  </action>
  <verify>
    1. `npm run typecheck` passes for both new component files
    2. adjustments-page.tsx: All 5 slider inputs write to `adjustments` signal (no DOM reads)
    3. adjustments-page.tsx: Calculate button calls `calculateResults()` from calculations.ts
    4. results-page.tsx: Uses `useEffect` to call `drawCharts` when results change
    5. results-page.tsx: Export button collects canvas images and calls `exportToPPT`
    6. Neither component has direct DOM queries (`document.getElementById`, `el(`, `querySelector`)
  </verify>
  <done>
    adjustments-page.tsx renders all adjustment controls (sliders, presets, observation calc, annualization) wired to the adjustments signal. results-page.tsx renders KPI tiles from results signal, mounts Chart.js via useEffect into canvas refs, and wires PPT export.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire App component, clean up index.html, verify full flow, and deploy</name>
  <files>
    src/app.tsx
    index.html
  </files>
  <action>
    **A. Update src/app.tsx — Full App shell with routing**

    Replace the placeholder from Plan 01 with the complete app shell:

    ```tsx
    import { currentPage } from "./state/store";
    import { Nav } from "./components/nav";
    import { UploadPage } from "./components/upload-page";
    import { AdjustmentsPage } from "./components/adjustments-page";
    import { ResultsPage } from "./components/results-page";

    export function App() {
      return (
        <div class="app">
          <div class="badge">
            <span>Loss &amp; ROI Analysis</span>
          </div>
          <h1>Site Loss Viewer &amp; Projected ROI</h1>
          <Nav />
          {currentPage.value === 1 && <UploadPage />}
          {currentPage.value === 2 && <AdjustmentsPage />}
          {currentPage.value === 3 && <ResultsPage />}
        </div>
      );
    }
    ```

    **B. Verify index.html is clean**

    index.html should contain ONLY:
    - DOCTYPE, html, head with meta tags
    - CDN script tags (3 libraries)
    - `<div id="app"></div>`
    - `<script type="module" src="/src/main.tsx"></script>`

    There should be NO:
    - Inline `<style>` tags (CSS is in src/styles.css)
    - Inline `<script>` tags (JS is in TypeScript modules)
    - Static HTML body content (rendered by Preact components)

    **C. Full integration test with dev server**

    Run `npm run dev` and test the complete wizard flow:

    1. Page 1 (Upload):
       - File input accepts .xlsx files
       - After upload, sheets are detected, header row found
       - Column mapping table shows auto-detected matches
       - "Apply Mapping & Continue" button loads data and navigates to page 2

    2. Page 2 (Adjustments):
       - Sliders have correct default values (Balanced preset)
       - Changing sliders updates adjustment values
       - Preset buttons update all sliders
       - Existing Customer toggle shows/hides Voxel Start Year
       - "Calculate & Show Results" button navigates to page 3

    3. Page 3 (Results):
       - KPI tiles show calculated values
       - Charts render (at least loss trend, category breakdown, cost comparison)
       - Export to PowerPoint generates and downloads a .pptx file
       - Charts collapse/expand when toggled

    Fix any integration issues:
    - Signal wiring between components
    - Import paths
    - Missing CSS classes
    - Chart rendering timing (useEffect dependencies)
    - TypeScript errors

    **D. Production build and deploy**

    1. Run `npm run build` — verify it produces dist/ with client assets + output wrangler.json
    2. Run `npm run deploy` (which runs `npm run build && wrangler deploy`)
    3. If deploy fails due to auth, that's expected — the execution workflow handles auth gates
    4. After deployment, verify the app is accessible at the production URL

    **CRITICAL:** Do NOT delete `src/worker.js`. It stays as a reference. The new SPA replaces the Worker's HTML-serving behavior via static assets, but the old file is kept until Phase 2.
  </action>
  <verify>
    1. `npm run typecheck` passes
    2. `npm run build` succeeds — dist/ directory created
    3. `npm run dev` — all 3 pages render and navigate correctly
    4. Full flow: upload a test Excel file → mapping → adjustments → results → charts → PPT export
    5. `npm run deploy` succeeds (or hits auth gate which is handled dynamically)
    6. No inline `<script>` or `<style>` in index.html
    7. `src/worker.js` still exists (not deleted)
  </verify>
  <done>
    App component wires all pages with signal-driven routing. index.html is clean (no inline code). Full wizard flow works end-to-end in dev. Production build succeeds. Application is deployed (or auth gate encountered).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Preact SPA replacing the monolithic Worker with modular TypeScript:
    - Vite build pipeline with Preact + Tailwind + Cloudflare plugins
    - 6 TypeScript lib modules (formatting, field-mapping, parsing, calculations, charts, export-ppt)
    - Centralized signal store replacing 6 global variables
    - 5 Preact components (nav, upload-page, adjustments-page, results-page, app)
    - Clean index.html with no inline code
    - Deployed to Cloudflare Workers
  </what-built>
  <how-to-verify>
    1. Open the dev server URL (http://localhost:5173) OR the production URL (https://lossrun.voxelplatform.com)
    2. Upload a test loss run Excel file
    3. Verify: Sheets detected correctly, column mapping table shows auto-detected matches
    4. Click "Apply Mapping & Continue" — should navigate to Adjustments page
    5. Verify: Sliders have default values, presets work, observation calculator expandable
    6. Click "Calculate & Show Results" — should navigate to Results page
    7. Verify: KPI tiles show calculated values (not zeros or NaN)
    8. Verify: Charts render (loss trend line, category breakdown, cost comparison at minimum)
    9. Click "Export to PowerPoint" — should download a .pptx file
    10. Open the downloaded .pptx — should have slides with data and chart images
    11. Compare behavior against the OLD tool (if still accessible at a different URL or via `npx wrangler dev` with old worker)
  </how-to-verify>
  <resume-signal>Type "approved" if the wizard flow works identically to the old tool, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. Full wizard flow: Upload → Map → Adjust → Calculate → Results → Export PPT
2. All 11 chart types render when data supports them
3. KPI values match the old tool for the same input file and adjustments
4. PPT export produces a valid PowerPoint file with charts and data
5. No inline `<script>` or `<style>` in index.html
6. `npm run typecheck` passes
7. `npm run build` succeeds
8. Application accessible at production URL
</verification>

<success_criteria>
- User completes the full wizard flow with identical behavior to the current production tool
- Application deploys to Cloudflare Workers and serves correctly
- All source code is in separate TypeScript files organized by responsibility
- Application state is managed through the signal store — no business logic reads from or writes to DOM elements
- PPT export generates a downloadable deck
- `src/worker.js` is preserved as reference (not deleted)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-build-infrastructure/01-04-SUMMARY.md`
</output>
